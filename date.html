<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Our Dates üíï</title>

<!--
====================================================
ROMANTIC DATE GALLERY ‚Äì ENHANCED VERSION
WITH PHASE 1 & PHASE 2 FEATURES
====================================================

Cloudinary Credentials:
- Cloud Name: dzfarzaew
- Upload Preset: date_gallery

Password: 1
Relationship Start: January 1, 2026
====================================================
-->

<style>
:root {
  --accent: #FFB5C5;
  --bg: #FFF5F7;
  --card: #FFFFFF;
  --text: #2D2424;
  --border: #FFE0E8;
  --shadow: rgba(255, 181, 197, 0.2);
  --heart-color: rgba(255, 181, 197, 0.6);
}

[data-theme="dark"] {
  --accent: #FFB5C5;
  --bg: #2D2424;
  --card: #3A3232;
  --text: #F5E6E8;
  --border: #4A4040;
  --shadow: rgba(0, 0, 0, 0.3);
  --heart-color: rgba(255, 181, 197, 0.3);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Verdana, Geneva, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding: 20px;
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.heart {
  position: fixed;
  width: 20px;
  height: 20px;
  background: var(--heart-color);
  transform: rotate(45deg);
  animation: float 15s infinite;
  pointer-events: none;
  z-index: 0;
  opacity: 0.6;
}

.heart::before,
.heart::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: var(--heart-color);
  border-radius: 50%;
}

.heart::before {
  left: -10px;
}

.heart::after {
  top: -10px;
}

@keyframes float {
  0% {
    transform: translateY(100vh) rotate(45deg);
    opacity: 0;
  }
  10% {
    opacity: 0.6;
  }
  90% {
    opacity: 0.6;
  }
  100% {
    transform: translateY(-100px) rotate(45deg);
    opacity: 0;
  }
}

.container {
  max-width: 900px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

header {
  text-align: center;
  margin-bottom: 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

h1 {
  font-size: 2.5em;
  color: var(--accent);
  text-shadow: 2px 2px 4px var(--shadow);
  flex: 1;
  min-width: 200px;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.header-buttons {
  display: flex;
  gap: 10px;
  align-items: center;
}

.theme-toggle {
  background: var(--card);
  border: 2px solid var(--accent);
  color: var(--text);
  padding: 10px 15px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 1.2em;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px var(--shadow);
}

.theme-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 8px var(--shadow);
}

.btn {
  background: var(--accent);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 1em;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px var(--shadow);
  font-family: Verdana, Geneva, sans-serif;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 8px var(--shadow);
  filter: brightness(1.1);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.counter {
  background: var(--card);
  padding: 30px;
  border-radius: 24px;
  text-align: center;
  margin-bottom: 30px;
  box-shadow: 0 8px 16px var(--shadow);
  border: 2px solid var(--border);
  transition: all 0.3s ease;
}

.counter:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 20px var(--shadow);
}

.counter-days {
  font-size: 3em;
  color: var(--accent);
  font-weight: bold;
  animation: pulse 2s ease-in-out infinite;
}

.counter-label {
  font-size: 1.2em;
  margin-top: 10px;
  color: var(--text);
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--card);
  padding: 20px;
  border-radius: 20px;
  text-align: center;
  box-shadow: 0 4px 8px var(--shadow);
  border: 2px solid var(--border);
  transition: all 0.3s ease;
  cursor: pointer;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 12px var(--shadow);
  border-color: var(--accent);
}

.stat-number {
  font-size: 2.5em;
  color: var(--accent);
  font-weight: bold;
}

.stat-label {
  font-size: 1em;
  color: var(--text);
  margin-top: 5px;
}

.action-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
  flex-wrap: wrap;
  margin-bottom: 30px;
}

.search-filter-bar {
  background: var(--card);
  padding: 20px;
  border-radius: 20px;
  margin-bottom: 30px;
  box-shadow: 0 4px 8px var(--shadow);
  border: 2px solid var(--border);
}

.search-box {
  width: 100%;
  padding: 12px 20px;
  border: 2px solid var(--border);
  border-radius: 16px;
  font-size: 1em;
  margin-bottom: 15px;
  font-family: Verdana, Geneva, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: all 0.3s ease;
}

.search-box:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(255, 181, 197, 0.2);
}

.filter-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}

.filter-btn {
  background: var(--bg);
  color: var(--text);
  border: 2px solid var(--border);
  padding: 10px 20px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 0.95em;
  font-weight: bold;
  transition: all 0.3s ease;
  font-family: Verdana, Geneva, sans-serif;
}

.filter-btn:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.filter-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

.timeline {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.date-card {
  background: var(--card);
  padding: 25px;
  border-radius: 20px;
  box-shadow: 0 4px 8px var(--shadow);
  border: 2px solid var(--border);
  transition: all 0.3s ease;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.date-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 12px var(--shadow);
  border-color: var(--accent);
}

.date-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 10px;
}

.date-info {
  flex: 1;
}

.date-title {
  font-size: 1.4em;
  color: var(--accent);
  font-weight: bold;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.favorite-star {
  color: gold;
  font-size: 1.2em;
}

.date-date {
  color: var(--text);
  opacity: 0.8;
}

.tag-badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: bold;
  margin-top: 8px;
}

.tag-romance {
  background: #FFE0E8;
  color: #D63384;
}

.tag-adventure {
  background: #E0F4FF;
  color: #0D6EFD;
}

.tag-fun {
  background: #FFF3CD;
  color: #FFC107;
}

.tag-cozy {
  background: #E0E0E0;
  color: #6C757D;
}

.date-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  background: var(--bg);
  border: 2px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.3s ease;
}

.icon-btn:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.date-photos {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  margin-top: 15px;
}

.photo-thumb {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid var(--border);
}

.photo-thumb:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px var(--shadow);
  border-color: var(--accent);
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  backdrop-filter: blur(5px);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal.active {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal-content {
  background: var(--card);
  padding: 30px;
  border-radius: 24px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  animation: slideIn 0.3s ease;
  position: relative;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title {
  font-size: 1.8em;
  color: var(--accent);
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.8em;
  color: var(--text);
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 5px;
  line-height: 1;
}

.close-btn:hover {
  color: var(--accent);
  transform: rotate(90deg);
}

.form-group {
  margin-bottom: 20px;
}

label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
  color: var(--text);
}

input[type="text"],
input[type="date"],
textarea,
select {
  width: 100%;
  padding: 12px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 1em;
  font-family: Verdana, Geneva, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: all 0.3s ease;
}

input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(255, 181, 197, 0.2);
}

textarea {
  resize: vertical;
  min-height: 100px;
}

.photo-preview {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  margin-top: 15px;
}

.preview-item {
  position: relative;
}

.preview-img {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 12px;
  border: 2px solid var(--border);
}

.remove-photo {
  position: absolute;
  top: 5px;
  right: 5px;
  background: rgba(255, 0, 0, 0.8);
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  font-size: 1em;
  line-height: 1;
  transition: all 0.3s ease;
}

.remove-photo:hover {
  background: red;
  transform: scale(1.1);
}

.lightbox {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 2000;
  animation: fadeIn 0.3s ease;
}

.lightbox.active {
  display: flex;
  justify-content: center;
  align-items: center;
}

.lightbox-content {
  position: relative;
  max-width: 90%;
  max-height: 90%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.lightbox-img {
  max-width: 100%;
  max-height: 90vh;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.lightbox-close {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  font-size: 2em;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.lightbox-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

.lightbox-nav {
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  font-size: 2em;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.lightbox-nav:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-50%) scale(1.1);
}

.lightbox-prev {
  left: 20px;
}

.lightbox-next {
  right: 20px;
}

.loading {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 3000;
  backdrop-filter: blur(5px);
}

.loading.active {
  display: flex;
  justify-content: center;
  align-items: center;
}

.loading-content {
  text-align: center;
  color: white;
}

.spinner {
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text);
  opacity: 0.7;
  animation: fadeIn 0.5s ease;
}

.empty-state-icon {
  font-size: 4em;
  margin-bottom: 20px;
}

.empty-state-text {
  font-size: 1.2em;
}

@media (max-width: 768px) {
  h1 {
    font-size: 2em;
  }

  header {
    flex-direction: column;
  }

  .header-buttons {
    width: 100%;
    justify-content: center;
  }

  .btn {
    padding: 14px 28px;
    font-size: 1.1em;
  }

  .action-buttons {
    flex-direction: column;
  }

  .action-buttons .btn {
    width: 100%;
  }

  .filter-buttons {
    flex-direction: column;
  }

  .filter-btn {
    width: 100%;
  }

  .date-actions {
    flex-wrap: wrap;
  }

  .lightbox-nav,
  .lightbox-close {
    width: 40px;
    height: 40px;
    font-size: 1.5em;
  }

  .lightbox-prev {
    left: 10px;
  }

  .lightbox-next {
    right: 10px;
  }
}

.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.modal-buttons .btn {
  flex: 1;
  min-width: 120px;
}

.view-photos {
  margin-top: 20px;
}

.view-photos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Our Dates üíï</h1>
    <div class="header-buttons">
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">üåô</button>
      <button class="btn" onclick="openAddModal()">‚ûï Add Date</button>
    </div>
  </header>

  <div class="counter">
    <div class="counter-days" id="daysCounter">0</div>
    <div class="counter-label">Days Together üíë</div>
  </div>

  <div class="stats">
    <div class="stat-card" onclick="filterByAll()" aria-label="View all dates">
      <div class="stat-number" id="totalDates">0</div>
      <div class="stat-label">Total Dates üìÖ</div>
    </div>
    <div class="stat-card" onclick="filterByYear()" aria-label="View this year's dates">
      <div class="stat-number" id="yearDates">0</div>
      <div class="stat-label">This Year üéâ</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalPhotos">0</div>
      <div class="stat-label">Total Photos üì∏</div>
    </div>
  </div>

  <div class="action-buttons">
    <button class="btn" onclick="randomMemory()">üé≤ Random Memory</button>
    <button class="btn" onclick="exportBackup()">üíæ Export Backup</button>
    <button class="btn" onclick="importBackup()">üì• Import Data</button>
  </div>

  <div class="search-filter-bar">
    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search dates by title or notes..." oninput="applyFilters()">
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
      <button class="filter-btn" data-filter="favorite" onclick="setFilter('favorite')">‚≠ê Favorites</button>
      <button class="filter-btn" data-filter="romance" onclick="setFilter('romance')">üíï Romance</button>
      <button class="filter-btn" data-filter="adventure" onclick="setFilter('adventure')">üéí Adventure</button>
      <button class="filter-btn" data-filter="fun" onclick="setFilter('fun')">üéâ Fun</button>
      <button class="filter-btn" data-filter="cozy" onclick="setFilter('cozy')">üè° Cozy</button>
    </div>
  </div>

  <div class="timeline" id="timeline"></div>
</div>

<!-- Add Date Modal -->
<div class="modal" id="addModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add New Date üíï</h2>
      <button class="close-btn" onclick="closeAddModal()">&times;</button>
    </div>
    <form onsubmit="addDate(event)">
      <div class="form-group">
        <label for="dateInput">Date</label>
        <input type="date" id="dateInput" required>
      </div>
      <div class="form-group">
        <label for="titleInput">Title</label>
        <input type="text" id="titleInput" placeholder="Our amazing date..." required>
      </div>
      <div class="form-group">
        <label for="tagInput">Category</label>
        <select id="tagInput">
          <option value="">No Category</option>
          <option value="romance">üíï Romance</option>
          <option value="adventure">üéí Adventure</option>
          <option value="fun">üéâ Fun</option>
          <option value="cozy">üè° Cozy</option>
        </select>
      </div>
      <div class="form-group">
        <label for="notesInput">Notes</label>
        <textarea id="notesInput" placeholder="What made this date special..."></textarea>
      </div>
      <div class="form-group">
        <label>Photos (optional)</label>
        <input type="file" id="photoInput" accept="image/*" multiple style="display:none;" onchange="previewPhotos(event)">
        <button type="button" class="btn" onclick="document.getElementById('photoInput').click()">üì∏ Choose Photos</button>
        <div class="photo-preview" id="photoPreview"></div>
      </div>
      <button type="submit" class="btn" style="width: 100%;">üíï Save Date</button>
    </form>
  </div>
</div>

<!-- View Date Modal -->
<div class="modal" id="viewModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="viewTitle"></h2>
      <button class="close-btn" onclick="closeViewModal()">&times;</button>
    </div>
    <div id="viewContent">
      <p><strong>Date:</strong> <span id="viewDate"></span></p>
      <p id="viewTagContainer"></p>
      <p><strong>Notes:</strong></p>
      <p id="viewNotes"></p>
      <div class="view-photos" id="viewPhotosContainer"></div>
    </div>
    <div class="modal-buttons">
      <button class="btn" onclick="toggleFavorite()">
        <span id="favoriteButtonText">‚òÜ Star</span>
      </button>
      <button class="btn" onclick="startSlideshow()">‚ñ∂Ô∏è Slideshow</button>
      <button class="btn" onclick="openEditModal()">‚úèÔ∏è Edit</button>
      <button class="btn" onclick="addMorePhotos()">üì∏ Add Photos</button>
      <button class="btn" onclick="confirmDelete()" style="background: #ff4444;">üóëÔ∏è Delete</button>
    </div>
  </div>
</div>

<!-- Edit Date Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Edit Date üíï</h2>
      <button class="close-btn" onclick="closeEditModal()">&times;</button>
    </div>
    <form onsubmit="saveEdit(event)">
      <div class="form-group">
        <label for="editDateInput">Date</label>
        <input type="date" id="editDateInput" required>
      </div>
      <div class="form-group">
        <label for="editTitleInput">Title</label>
        <input type="text" id="editTitleInput" required>
      </div>
      <div class="form-group">
        <label for="editTagInput">Category</label>
        <select id="editTagInput">
          <option value="">No Category</option>
          <option value="romance">üíï Romance</option>
          <option value="adventure">üéí Adventure</option>
          <option value="fun">üéâ Fun</option>
          <option value="cozy">üè° Cozy</option>
        </select>
      </div>
      <div class="form-group">
        <label for="editNotesInput">Notes</label>
        <textarea id="editNotesInput"></textarea>
      </div>
      <div class="form-group">
        <label>Current Photos</label>
        <div class="photo-preview" id="editPhotoPreview"></div>
      </div>
      <button type="submit" class="btn" style="width: 100%;">üíï Save Changes</button>
    </form>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
  <button class="lightbox-nav lightbox-prev" onclick="prevPhoto()">‚Äπ</button>
  <div class="lightbox-content">
    <img class="lightbox-img" id="lightboxImg" src="" alt="Full size photo">
  </div>
  <button class="lightbox-nav lightbox-next" onclick="nextPhoto()">‚Ä∫</button>
</div>

<!-- Loading Overlay -->
<div class="loading" id="loading">
  <div class="loading-content">
    <div class="spinner"></div>
    <p id="loadingText">Uploading photos... üíï</p>
  </div>
</div>

<script src="https://upload-widget.cloudinary.com/global/all.js"></script>

<script>
// ====================================================
// CONSTANTS & GLOBAL VARIABLES
// ====================================================

const CLOUDINARY_CLOUD_NAME = 'dzfarzaew';
const CLOUDINARY_UPLOAD_PRESET = 'date_gallery';
const RELATIONSHIP_START = new Date('2026-01-01');
const PASSWORD = '1';

let dates = [];
let currentViewIndex = -1;
let currentLightboxIndex = -1;
let currentLightboxPhotos = [];
let currentFilter = 'all';
let slideshowInterval = null;

// ====================================================
// INITIALIZATION
// ====================================================

window.onload = function() {
  checkPassword();
  loadDates();
  updateCounter();
  createFloatingHearts();
  loadTheme();

  // Set today's date as default
  document.getElementById('dateInput').valueAsDate = new Date();

  // Update counter every second
  setInterval(updateCounter, 1000);

  // Keyboard shortcuts
  document.addEventListener('keydown', handleKeyboardShortcuts);
};

function checkPassword() {
  const saved = localStorage.getItem('dateGalleryAuth');
  if (saved !== PASSWORD) {
    const input = prompt('Enter password to access:');
    if (input === PASSWORD) {
      localStorage.setItem('dateGalleryAuth', PASSWORD);
    } else {
      alert('Incorrect password!');
      document.body.innerHTML = '<h1 style="text-align:center;margin-top:50px;">Access Denied üíî</h1>';
    }
  }
}

function loadDates() {
  const stored = localStorage.getItem('romanticDates');
  if (stored) {
    dates = JSON.parse(stored);
    // Ensure all dates have favorite property
    dates = dates.map(d => ({
      ...d,
      favorite: d.favorite || false,
      tag: d.tag || ''
    }));
    saveDates();
  }
  applyFilters();
  updateStats();
}

function saveDates() {
  localStorage.setItem('romanticDates', JSON.stringify(dates));
}

function createFloatingHearts() {
  for (let i = 0; i < 15; i++) {
    const heart = document.createElement('div');
    heart.className = 'heart';
    heart.style.left = Math.random() * 100 + '%';
    heart.style.animationDelay = Math.random() * 15 + 's';
    heart.style.animationDuration = (Math.random() * 10 + 10) + 's';
    document.body.appendChild(heart);
  }
}

// ====================================================
// THEME
// ====================================================

function loadTheme() {
  const theme = localStorage.getItem('dateGalleryTheme') || 'light';
  if (theme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
  }
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('dateGalleryTheme', newTheme);
  document.querySelector('.theme-toggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

// ====================================================
// COUNTER & STATS
// ====================================================

function updateCounter() {
  const now = new Date();
  const diff = now - RELATIONSHIP_START;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  document.getElementById('daysCounter').textContent = days;
}

function updateStats() {
  const totalDates = dates.length;
  const currentYear = new Date().getFullYear();
  const yearDates = dates.filter(d => new Date(d.date).getFullYear() === currentYear).length;
  const totalPhotos = dates.reduce((sum, d) => sum + (d.images ? d.images.length : 0), 0);

  document.getElementById('totalDates').textContent = totalDates;
  document.getElementById('yearDates').textContent = yearDates;
  document.getElementById('totalPhotos').textContent = totalPhotos;
}

function filterByAll() {
  setFilter('all');
}

function filterByYear() {
  const currentYear = new Date().getFullYear();
  const filtered = dates.filter(d => new Date(d.date).getFullYear() === currentYear);
  renderTimeline(filtered);
}

// ====================================================
// SEARCH & FILTER
// ====================================================

function setFilter(filter) {
  currentFilter = filter;

  // Update active button
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

  applyFilters();
}

function applyFilters() {
  let filtered = [...dates];

  // Apply category/favorite filter
  if (currentFilter === 'favorite') {
    filtered = filtered.filter(d => d.favorite);
  } else if (currentFilter !== 'all') {
    filtered = filtered.filter(d => d.tag === currentFilter);
  }

  // Apply search filter
  const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
  if (searchTerm) {
    filtered = filtered.filter(d => 
      d.title.toLowerCase().includes(searchTerm) ||
      (d.notes && d.notes.toLowerCase().includes(searchTerm))
    );
  }

  renderTimeline(filtered);
}

// ====================================================
// TIMELINE
// ====================================================

function renderTimeline(datesToRender = null) {
  const timeline = document.getElementById('timeline');
  const displayDates = datesToRender || dates;

  if (displayDates.length === 0) {
    const message = currentFilter !== 'all' || document.getElementById('searchBox').value
      ? 'No dates found. Try adjusting your filters! üíï'
      : 'No dates yet! Click "Add Date" to start capturing your memories together üíï';

    timeline.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üíî</div>
        <div class="empty-state-text">${message}</div>
      </div>
    `;
    return;
  }

  // Sort by date (oldest to newest)
  const sorted = [...displayDates].sort((a, b) => new Date(a.date) - new Date(b.date));

  timeline.innerHTML = sorted.map((dateObj, index) => {
    const actualIndex = dates.findIndex(d => d === dateObj);
    const formattedDate = formatDate(dateObj.date);
    const photoCount = dateObj.images ? dateObj.images.length : 0;
    const favoriteIcon = dateObj.favorite ? '<span class="favorite-star">‚≠ê</span>' : '';
    const tagBadge = dateObj.tag ? getTagBadge(dateObj.tag) : '';

    const photosHTML = dateObj.images && dateObj.images.length > 0
      ? `<div class="date-photos">
          ${dateObj.images.slice(0, 4).map((img, i) => 
            `<img src="${img.url}" class="photo-thumb" alt="Date photo" onclick="openLightboxFromCard(${actualIndex}, ${i})">`
          ).join('')}
          ${dateObj.images.length > 4 ? `<div style="grid-column: span 1; display: flex; align-items: center; justify-content: center; background: var(--border); border-radius: 12px; font-weight: bold; color: var(--accent);">+${dateObj.images.length - 4}</div>` : ''}
        </div>`
      : '';

    return `
      <div class="date-card">
        <div class="date-header">
          <div class="date-info">
            <div class="date-title">
              ${favoriteIcon}
              ${dateObj.title}
            </div>
            <div class="date-date">${formattedDate}</div>
            ${tagBadge}
          </div>
          <div class="date-actions">
            <button class="icon-btn" onclick="viewDate(${actualIndex})" title="View">üëÅÔ∏è</button>
            <button class="icon-btn" onclick="openEditModalDirect(${actualIndex})" title="Edit">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="confirmDeleteDirect(${actualIndex})" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
        ${dateObj.notes ? `<p style="margin-top: 10px; opacity: 0.9;">${truncateText(dateObj.notes, 150)}</p>` : ''}
        ${photosHTML}
        ${photoCount > 0 ? `<p style="margin-top: 10px; opacity: 0.7; font-size: 0.9em;">üì∏ ${photoCount} photo${photoCount > 1 ? 's' : ''}</p>` : ''}
      </div>
    `;
  }).join('');
}

function getTagBadge(tag) {
  const tagIcons = {
    romance: 'üíï',
    adventure: 'üéí',
    fun: 'üéâ',
    cozy: 'üè°'
  };
  const tagNames = {
    romance: 'Romance',
    adventure: 'Adventure',
    fun: 'Fun',
    cozy: 'Cozy'
  };
  return `<span class="tag-badge tag-${tag}">${tagIcons[tag]} ${tagNames[tag]}</span>`;
}

function formatDate(dateStr) {
  const date = new Date(dateStr + 'T00:00:00');
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

function truncateText(text, maxLength) {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

// ====================================================
// ADD DATE
// ====================================================

function openAddModal() {
  document.getElementById('addModal').classList.add('active');
  document.getElementById('dateInput').valueAsDate = new Date();
  document.getElementById('titleInput').value = '';
  document.getElementById('tagInput').value = '';
  document.getElementById('notesInput').value = '';
  document.getElementById('photoInput').value = '';
  document.getElementById('photoPreview').innerHTML = '';
}

function closeAddModal() {
  document.getElementById('addModal').classList.remove('active');
}

let pendingPhotos = [];

function previewPhotos(event) {
  const files = Array.from(event.target.files);
  pendingPhotos = files;

  const preview = document.getElementById('photoPreview');
  preview.innerHTML = '';

  files.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `
        <img src="${e.target.result}" class="preview-img" alt="Preview">
        <button type="button" class="remove-photo" onclick="removePreview(${index})">&times;</button>
      `;
      preview.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}

function removePreview(index) {
  pendingPhotos.splice(index, 1);

  // Re-render preview
  const preview = document.getElementById('photoPreview');
  preview.innerHTML = '';

  pendingPhotos.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `
        <img src="${e.target.result}" class="preview-img" alt="Preview">
        <button type="button" class="remove-photo" onclick="removePreview(${i})">&times;</button>
      `;
      preview.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}

async function addDate(event) {
  event.preventDefault();

  const date = document.getElementById('dateInput').value;
  const title = document.getElementById('titleInput').value;
  const tag = document.getElementById('tagInput').value;
  const notes = document.getElementById('notesInput').value;

  if (!date || !title) {
    alert('Please fill in date and title! üíï');
    return;
  }

  const loading = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');

  try {
    let images = [];

    if (pendingPhotos.length > 0) {
      loading.classList.add('active');
      loadingText.textContent = 'Uploading photos... üíï';

      for (let i = 0; i < pendingPhotos.length; i++) {
        loadingText.textContent = `Uploading photo ${i + 1} of ${pendingPhotos.length}... üíï`;

        const formData = new FormData();
        formData.append('file', pendingPhotos[i]);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
          {
            method: 'POST',
            body: formData
          }
        );

        const data = await response.json();
        images.push({ url: data.secure_url });
      }
    }

    const newDate = {
      date,
      title,
      tag,
      notes,
      images,
      favorite: false
    };

    dates.push(newDate);
    saveDates();
    applyFilters();
    updateStats();

    loading.classList.remove('active');
    closeAddModal();

    alert('Date added successfully! üíï');
    pendingPhotos = [];

  } catch (error) {
    loading.classList.remove('active');
    alert('Error adding date. Please try again. üíî');
    console.error('Error:', error);
  }
}

// ====================================================
// VIEW DATE
// ====================================================

function viewDate(index) {
  currentViewIndex = index;
  const dateObj = dates[index];

  document.getElementById('viewTitle').textContent = dateObj.title;
  document.getElementById('viewDate').textContent = formatDate(dateObj.date);
  document.getElementById('viewNotes').textContent = dateObj.notes || 'No notes added.';

  // Display tag
  const tagContainer = document.getElementById('viewTagContainer');
  if (dateObj.tag) {
    tagContainer.innerHTML = `<strong>Category:</strong> ${getTagBadge(dateObj.tag)}`;
  } else {
    tagContainer.innerHTML = '';
  }

  // Update favorite button
  const favoriteBtn = document.getElementById('favoriteButtonText');
  favoriteBtn.textContent = dateObj.favorite ? '‚≠ê Starred' : '‚òÜ Star';

  // Display photos
  const photosContainer = document.getElementById('viewPhotosContainer');
  if (dateObj.images && dateObj.images.length > 0) {
    photosContainer.innerHTML = `
      <h3 style="margin-bottom: 10px;">Photos (${dateObj.images.length})</h3>
      <div class="view-photos-grid">
        ${dateObj.images.map((img, i) => 
          `<img src="${img.url}" class="photo-thumb" alt="Date photo" onclick="openLightbox(${index}, ${i})">`
        ).join('')}
      </div>
    `;
  } else {
    photosContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì∏</div>
        <div class="empty-state-text">No photos uploaded yet. Click 'Add More Photos' to add some! üì∏</div>
      </div>
    `;
  }

  document.getElementById('viewModal').classList.add('active');
}

function closeViewModal() {
  document.getElementById('viewModal').classList.remove('active');
  currentViewIndex = -1;
}

function toggleFavorite() {
  if (currentViewIndex === -1) return;

  dates[currentViewIndex].favorite = !dates[currentViewIndex].favorite;
  saveDates();

  const favoriteBtn = document.getElementById('favoriteButtonText');
  favoriteBtn.textContent = dates[currentViewIndex].favorite ? '‚≠ê Starred' : '‚òÜ Star';

  applyFilters();
  updateStats();
}

// ====================================================
// EDIT DATE
// ====================================================

function openEditModal() {
  if (currentViewIndex === -1) return;

  const dateObj = dates[currentViewIndex];

  document.getElementById('editDateInput').value = dateObj.date;
  document.getElementById('editTitleInput').value = dateObj.title;
  document.getElementById('editTagInput').value = dateObj.tag || '';
  document.getElementById('editNotesInput').value = dateObj.notes || '';

  // Display current photos
  const preview = document.getElementById('editPhotoPreview');
  if (dateObj.images && dateObj.images.length > 0) {
    preview.innerHTML = dateObj.images.map((img, i) => `
      <div class="preview-item">
        <img src="${img.url}" class="preview-img" alt="Photo">
        <button type="button" class="remove-photo" onclick="removeExistingPhoto(${i})">&times;</button>
      </div>
    `).join('');
  } else {
    preview.innerHTML = '<p style="opacity: 0.7;">No photos</p>';
  }

  closeViewModal();
  document.getElementById('editModal').classList.add('active');
}

function openEditModalDirect(index) {
  currentViewIndex = index;
  openEditModal();
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
}

function removeExistingPhoto(photoIndex) {
  if (currentViewIndex === -1) return;

  if (confirm('Remove this photo? This cannot be undone! üíî')) {
    dates[currentViewIndex].images.splice(photoIndex, 1);
    saveDates();

    // Refresh preview
    const preview = document.getElementById('editPhotoPreview');
    const dateObj = dates[currentViewIndex];
    if (dateObj.images && dateObj.images.length > 0) {
      preview.innerHTML = dateObj.images.map((img, i) => `
        <div class="preview-item">
          <img src="${img.url}" class="preview-img" alt="Photo">
          <button type="button" class="remove-photo" onclick="removeExistingPhoto(${i})">&times;</button>
        </div>
      `).join('');
    } else {
      preview.innerHTML = '<p style="opacity: 0.7;">No photos</p>';
    }

    applyFilters();
    updateStats();
  }
}

function saveEdit(event) {
  event.preventDefault();

  if (currentViewIndex === -1) return;

  const date = document.getElementById('editDateInput').value;
  const title = document.getElementById('editTitleInput').value;
  const tag = document.getElementById('editTagInput').value;
  const notes = document.getElementById('editNotesInput').value;

  if (!date || !title) {
    alert('Please fill in date and title! üíï');
    return;
  }

  dates[currentViewIndex].date = date;
  dates[currentViewIndex].title = title;
  dates[currentViewIndex].tag = tag;
  dates[currentViewIndex].notes = notes;

  saveDates();
  applyFilters();
  updateStats();
  closeEditModal();

  alert('Changes saved! üíï');
}

// ====================================================
// DELETE DATE
// ====================================================

function confirmDelete() {
  if (currentViewIndex === -1) return;

  if (confirm('Are you sure you want to delete this date? This cannot be undone! üíî')) {
    dates.splice(currentViewIndex, 1);
    saveDates();
    applyFilters();
    updateStats();
    closeViewModal();
    alert('Date deleted üíî');
  }
}

function confirmDeleteDirect(index) {
  if (confirm('Are you sure you want to delete this date? This cannot be undone! üíî')) {
    dates.splice(index, 1);
    saveDates();
    applyFilters();
    updateStats();
    alert('Date deleted üíî');
  }
}

// ====================================================
// ADD MORE PHOTOS
// ====================================================

async function addMorePhotos() {
  if (currentViewIndex === -1) return;

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = true;

  input.onchange = async function(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;

    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');

    try {
      loading.classList.add('active');
      const images = [];

      for (let i = 0; i < files.length; i++) {
        loadingText.textContent = `Uploading photo ${i + 1} of ${files.length}... üíï`;

        const formData = new FormData();
        formData.append('file', files[i]);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        const response = await fetch(
          `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
          {
            method: 'POST',
            body: formData
          }
        );

        const data = await response.json();
        images.push({ url: data.secure_url });
      }

      if (!dates[currentViewIndex].images) {
        dates[currentViewIndex].images = [];
      }

      dates[currentViewIndex].images.push(...images);
      saveDates();

      loading.classList.remove('active');
      loadingText.textContent = 'Uploading photos... üíï';

      viewDate(currentViewIndex);
      applyFilters();
      updateStats();

      alert(`Added ${images.length} photo${images.length > 1 ? 's' : ''} successfully! üíï`);

    } catch (error) {
      loading.classList.remove('active');
      loadingText.textContent = 'Uploading photos... üíï';
      alert('Error uploading photos. Please try again. üíî');
      console.error('Upload error:', error);
    }
  };

  input.click();
}

// ====================================================
// LIGHTBOX
// ====================================================

function openLightbox(dateIndex, photoIndex) {
  currentLightboxPhotos = dates[dateIndex].images;
  currentLightboxIndex = photoIndex;
  showLightboxPhoto();
  document.getElementById('lightbox').classList.add('active');
  stopSlideshow();
}

function openLightboxFromCard(dateIndex, photoIndex) {
  openLightbox(dateIndex, photoIndex);
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('active');
  currentLightboxPhotos = [];
  currentLightboxIndex = -1;
  stopSlideshow();
}

function showLightboxPhoto() {
  if (currentLightboxPhotos.length === 0) return;
  document.getElementById('lightboxImg').src = currentLightboxPhotos[currentLightboxIndex].url;
}

function nextPhoto() {
  if (currentLightboxPhotos.length === 0) return;
  currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxPhotos.length;
  showLightboxPhoto();
}

function prevPhoto() {
  if (currentLightboxPhotos.length === 0) return;
  currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxPhotos.length) % currentLightboxPhotos.length;
  showLightboxPhoto();
}

// ====================================================
// SLIDESHOW
// ====================================================

function startSlideshow() {
  if (currentViewIndex === -1) return;

  const dateObj = dates[currentViewIndex];
  if (!dateObj.images || dateObj.images.length === 0) {
    alert('No photos to show in slideshow! üì∏');
    return;
  }

  currentLightboxPhotos = dateObj.images;
  currentLightboxIndex = 0;
  showLightboxPhoto();
  document.getElementById('lightbox').classList.add('active');

  slideshowInterval = setInterval(() => {
    nextPhoto();
  }, 3000);
}

function stopSlideshow() {
  if (slideshowInterval) {
    clearInterval(slideshowInterval);
    slideshowInterval = null;
  }
}

// ====================================================
// RANDOM MEMORY
// ====================================================

function randomMemory() {
  if (dates.length === 0) {
    alert('No dates to show yet! Add some memories first üíï');
    return;
  }

  const randomIndex = Math.floor(Math.random() * dates.length);
  viewDate(randomIndex);
}

// ====================================================
// EXPORT/IMPORT
// ====================================================

function exportBackup() {
  if (dates.length === 0) {
    alert('No dates to export! üíî');
    return;
  }

  const dataStr = JSON.stringify(dates, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const today = new Date();
  const dateStr = today.toISOString().split('T')[0];
  const filename = `our-dates-backup-${dateStr}.json`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();

  URL.revokeObjectURL(url);
  alert('Backup downloaded! üíï');
}

function importBackup() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';

  input.onchange = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedDates = JSON.parse(e.target.result);

        if (!Array.isArray(importedDates)) {
          alert('Invalid backup file format! üíî');
          return;
        }

        const confirmed = confirm(
          `This will replace all current data with ${importedDates.length} imported dates. Continue?`
        );

        if (confirmed) {
          dates = importedDates;
          saveDates();
          applyFilters();
          updateStats();
          alert('Data imported successfully! üíï');
        }

      } catch (error) {
        alert('Error reading backup file! üíî');
        console.error('Import error:', error);
      }
    };
    reader.readAsText(file);
  };

  input.click();
}

// ====================================================
// KEYBOARD SHORTCUTS
// ====================================================

function handleKeyboardShortcuts(event) {
  // Don't trigger shortcuts when typing in inputs
  const isTyping = event.target.tagName === 'INPUT' || 
                   event.target.tagName === 'TEXTAREA' ||
                   event.target.tagName === 'SELECT';

  if (isTyping) return;

  // ESC key - close modals/lightbox
  if (event.key === 'Escape') {
    if (document.getElementById('lightbox').classList.contains('active')) {
      closeLightbox();
    } else if (document.getElementById('viewModal').classList.contains('active')) {
      closeViewModal();
    } else if (document.getElementById('editModal').classList.contains('active')) {
      closeEditModal();
    } else if (document.getElementById('addModal').classList.contains('active')) {
      closeAddModal();
    }
  }

  // Ctrl+N - open add date modal
  if (event.ctrlKey && event.key === 'n') {
    event.preventDefault();
    openAddModal();
  }

  // Arrow keys in lightbox
  if (document.getElementById('lightbox').classList.contains('active')) {
    if (event.key === 'ArrowLeft') {
      prevPhoto();
    } else if (event.key === 'ArrowRight') {
      nextPhoto();
    }
  }
}

// ====================================================
// TOUCH GESTURES (Mobile)
// ====================================================

let touchStartX = 0;
let touchEndX = 0;

document.getElementById('lightbox').addEventListener('touchstart', function(event) {
  touchStartX = event.changedTouches[0].screenX;
}, false);

document.getElementById('lightbox').addEventListener('touchend', function(event) {
  touchEndX = event.changedTouches[0].screenX;
  handleSwipe();
}, false);

function handleSwipe() {
  const swipeThreshold = 50;
  const diff = touchStartX - touchEndX;

  if (Math.abs(diff) > swipeThreshold) {
    if (diff > 0) {
      nextPhoto();
    } else {
      prevPhoto();
    }
  }
}

// ====================================================
// UTILITY FUNCTIONS
// ====================================================

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', function(event) {
    if (event.target === modal) {
      modal.classList.remove('active');
      if (modal.id === 'viewModal') currentViewIndex = -1;
    }
  });
});

// Close lightbox when clicking outside image
document.getElementById('lightbox').addEventListener('click', function(event) {
  if (event.target === this) {
    closeLightbox();
  }
});

</script>

</body>
</html>